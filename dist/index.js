!function(t){"function"==typeof define&&define.amd?define(t):t()}((function(){"use strict";const t=["#00f0f0","#0000f5","#f0a000","#f0f000","#00f000","#a000f0","#f00000"],e=[[[1,1,1,1]],[[2,0,0],[2,2,2]],[[0,0,3],[3,3,3]],[[4,4],[4,4]],[[0,5,5],[5,5,0]],[[0,6,0],[6,6,6]],[[7,7,0],[0,7,7]]];class s{constructor(t,e,s=null){this.board=t,this.shape=e,this.position=s,this.downTick=0,this.position||(this.position={x:Math.floor(this.board.getWidth()/2-this.shape[0].length/2),y:-this.shape.length})}static randomShape(t){const i=e[Math.floor(Math.random()*e.length)];return new s(t,i)}rotate(){let t=!1;const e=this.shape,s=e.length,i=e[0].length,h=[];for(let t=0;t<i;t++){const i=[];for(let h=s-1;h>=0;h--)i.push(e[h][t]);h.push(i)}const o=this.position.y+Math.floor(this.shape.length/2)-Math.floor(h.length/2),a=this.position.x+Math.floor(this.shape[0].length/2)-Math.floor(h[0].length/2),r=a+h[0].length<=this.board.getWidth()&&a>=0,n=o+h.length<=this.board.getHeight();if(r&&n){const e=structuredClone(this.board.getBoard());for(let t=0;t<this.shape.length;++t)for(let s=0;s<this.shape[t].length;++s)this.position.y+t>=0&&(e[t+this.position.y][s+this.position.x]=0);for(let s=0;s<h.length;++s)for(let i=0;i<h[s].length;++i)if(o+s>=0&&0!==e[s+o][i+a])return t;t=!0,this.position.y=o,this.position.x=a,this.shape=h}return this.board.update(!1),t}canGoLeft(){var t;const e=this.shape,s=this.position,i=this.board.getBoard();for(let h=0;h<e.length;++h)for(let o=0;o<e[h].length;++o){if((0===e[h][o-1]||void 0===e[h][o-1])&&0!==(null===(t=i[h+s.y])||void 0===t?void 0:t[o+s.x-1])&&0!==s.x&&0!==e[h][o])return!1}return!0}canGoRiht(){var t;const e=this.shape,s=this.position,i=this.board.getBoard();for(let h=0;h<e.length;++h)for(let o=0;o<e[h].length;++o){if(s.y+h>=0&&(0===e[h][o+1]||void 0===e[h][o+1])&&0!==(null===(t=i[h+s.y])||void 0===t?void 0:t[o+s.x+1])&&s.x!==this.board.getWidth()-e[0].length&&0!==e[h][o])return!1}return!0}canGoDown(){var t,e,s;if(this.haveReachedBottom())return++this.downTick,this.downTick<=1;const i=this.shape,h=this.position,o=this.board.getBoard();for(let a=0;a<i.length;++a)for(let r=0;r<i[a].length;++r){if(h.y+a+1>=0&&(0===(null===(t=i[a+1])||void 0===t?void 0:t[r])||void 0===(null===(e=i[a+1])||void 0===e?void 0:e[r]))&&0!==(null===(s=o[a+h.y+1])||void 0===s?void 0:s[r+h.x])&&0!==i[a][r])return++this.downTick,this.downTick<=1}return this.downTick=0,!0}goDown(){this.position.y!==this.board.getHeight()-this.shape.length&&0===this.downTick&&++this.position.y,this.board.update(!1)}goRight(){this.canGoRiht()&&(this.position.x!==this.board.getWidth()-this.shape[0].length&&++this.position.x,this.board.update(!1))}goLeft(){this.canGoLeft()&&(0!==this.position.x&&this.position.x--,this.board.update(!1))}haveReachedBottom(){return this.position.y===this.board.getHeight()-this.shape.length}getShape(){return this.shape}getPosition(){return this.position}copy(){return new s(this.board,this.shape,structuredClone(this.position))}}class i{constructor(t=12,e=24){this.width=t,this.height=e,this.board=[],this.score=0,this.actualShape=s.randomShape(this),this.nextShape=s.randomShape(this),this.buildBoard()}buildBoard(){for(let t=0;t<this.width*this.height;++t)t%this.width==0&&this.board.push([]),this.board[this.board.length-1].push(0)}removeLastShapeDraw(){if(!this.backShape)return;const t=this.backShape.getShape(),e=this.backShape.getPosition();for(let s=0;s<t.length;++s)for(let i=0;i<t[s].length;++i)e.y+s<0||0!==t[s][i]&&(this.board[s+e.y][i+e.x]=0)}displayShape(){const t=this.actualShape.getShape(),e=this.actualShape.getPosition();for(let s=0;s<t.length;++s)for(let i=0;i<t[s].length;++i)e.y+s<0||0!==t[s][i]&&(this.board[s+e.y][i+e.x]=t[s][i])}haveLoose(){return this.board[0].some((t=>0!==t))&&!this.actualShape.canGoDown()}getScoreFromCompletedLine(t){switch(t){case 0:return 0;case 1:return 40;case 2:return 100;case 3:return 300;default:return 1200}}removeCompletedLines(){let t=0;for(let e=0;e<this.board.length;++e){this.board[e].every((t=>0!==t))&&(++t,this.board.splice(e,1),this.board.unshift(Array(this.width).fill(0)))}this.score+=this.getScoreFromCompletedLine(t)}update(t=!0){this.removeLastShapeDraw(),this.actualShape.canGoDown()||(this.score+=this.actualShape.getShape().length+1,this.displayShape(),this.removeCompletedLines(),this.actualShape=this.nextShape,this.nextShape=s.randomShape(this)),this.backShape=this.actualShape.copy(),t&&this.actualShape.goDown(),this.displayShape()}getScore(){return this.score}getBoard(){return this.board}getWidth(){return this.width}getHeight(){return this.height}getActualShape(){return this.actualShape}getNextShape(){return this.nextShape}getBackShape(){return this.backShape}setActualShape(t){this.actualShape=t}setNextShape(t){this.nextShape=t}setBackShape(t){this.backShape=t}setBoard(t){this.board=t}setScore(t){this.score=t}reset(){this.board=[],this.actualShape=s.randomShape(this),this.nextShape=s.randomShape(this),this.backShape=null,this.score=0,this.buildBoard()}copy(){const t=new i(this.width,this.height);return t.setActualShape(this.actualShape.copy()),t.setNextShape(this.nextShape.copy()),t.setBackShape(this.backShape.copy()),t.setBoard(structuredClone(this.board)),t.setScore(this.score),t}}class h{constructor(t,e){this.gameHandler=t,this.keys=e,this.initKeyListener()}initKeyListener(){const t=this.gameHandler.getBoard();document.addEventListener("keydown",(e=>{if(!this.gameHandler.isRunning())return;const s=e.key,i=Object.entries(this.keys).find((t=>t[1].toLocaleLowerCase()===s.toLocaleLowerCase()));if(i){const e=t.getActualShape();switch(i[0]){case"RIGHT":e.goRight();break;case"LEFT":e.goLeft();break;case"DOWN":e.goDown();break;case"ROTATE":e.rotate()}this.gameHandler.drawGame(),t.haveLoose()&&this.gameHandler.loose()}}))}}var o;!function(t){t.LOOSE="You loose",t.NOT_PLAYING="Not playing",t.PLAYING="Playing"}(o||(o={}));const a=400,r={RIGHT:"ArrowRight",DOWN:"ArrowDown",LEFT:"ArrowLeft",ROTATE:"ArrowUp"};const n=document.querySelector("canvas"),c=document.querySelector("#play"),l=document.querySelector("#pause"),d=document.querySelector("#reset"),g=new class{constructor(t){this.canvas=t,this.board=new i,this.gameStatus=o.NOT_PLAYING,this.ctx=this.canvas.getContext("2d"),this.canvasWidth=t.width,this.canvasHeight=t.height,this.keyHandler=new h(this,r),this.drawGame()}drawPolygon(t,e){this.ctx.fillStyle=e,this.ctx.beginPath(),this.ctx.moveTo(t[0].x,t[0].y);for(let e=1;e<t.length;++e)this.ctx.lineTo(t[e].x,t[e].y);this.ctx.closePath(),this.ctx.fill()}drawBorder(t,e){const s=this.canvasWidth/2/this.board.getWidth(),i=this.canvasHeight/this.board.getHeight();this.ctx.beginPath(),this.ctx.strokeStyle="#ffffff10",this.ctx.rect(t*s,e*i,s,i),this.ctx.stroke()}drawRect(t,e,s,i=0,h=0){const o=this.canvasWidth/2/this.board.getWidth(),a=this.canvasHeight/this.board.getHeight(),r=t*o+i,n=e*a+h;this.ctx.fillStyle=s,this.ctx.fillRect(r,n,o,a);const c=[{x:r,y:n},{x:r+o,y:n},{x:r+o-a/4,y:n+a/4},{x:r+a/4,y:n+a/4}],l=[{x:r,y:n+a},{x:r+o,y:n+a},{x:r+o-a/4,y:n+a-a/4},{x:r+a/4,y:n+a-a/4}],d=[{x:r,y:n},{x:r+o/4,y:n+o/4},{x:r+o/4,y:n+a-o/4},{x:r,y:n+a}],g=[{x:r+o,y:n},{x:r+o-o/4,y:n+o/4},{x:r+o-o/4,y:n+a-o/4},{x:r+o,y:n+a}];this.drawPolygon(c,"#ffffff80"),this.drawPolygon(l,"#00000080"),this.drawPolygon(d,"#00000050"),this.drawPolygon(g,"#00000050")}drawGame(){const e="#212129";this.ctx.clearRect(0,0,this.canvasWidth,this.canvasHeight),this.ctx.fillStyle=e,this.ctx.fillRect(0,0,this.canvasWidth/2,this.canvasHeight);const s=this.board.getBoard();for(let e=0;e<s.length;++e)for(let i=0;i<s[e].length;++i){if(0===s[e][i]){this.drawBorder(i,e);continue}const h=t[s[e][i]-1];this.drawRect(i,e,h)}const i=this.canvasWidth/2+10;this.ctx.fillStyle=e,this.ctx.font="20px Arial, sans-serif",this.ctx.fillText("Score: "+this.board.getScore(),i,35),this.ctx.fillText("Game status:",i,65),this.ctx.fillText("> "+this.gameStatus,i,85),this.ctx.fillText("Next Shape:",i,115);const h=this.board.getNextShape().getShape();for(let e=0;e<h.length;++e)for(let s=0;s<h[e].length;++s){if(0===h[e][s])continue;const o=t[h[e][s]-1];this.drawRect(s,e,o,i,125)}}loose(){this.gameStatus=o.LOOSE,this.drawGame(),this.reset(!1)}start(){this.clock||(this.gameStatus=o.PLAYING,this.clock=setInterval((()=>{this.board.update(),this.drawGame(),this.board.haveLoose()&&this.loose()}),a))}stop(){clearInterval(this.clock),this.gameStatus=o.NOT_PLAYING,this.clock=null}reset(t=!0){this.stop(),this.board.reset(),t&&this.drawGame()}isRunning(){return!!this.clock}getBoard(){return this.board}}(n);c.addEventListener("click",(()=>g.start())),l.addEventListener("click",(()=>g.stop())),d.addEventListener("click",(()=>g.reset()));const p=new class{constructor(t){this.gameHandler=t,this.fps=10}ai(t){}main(){const t=this.gameHandler.getBoard(),e=t.getActualShape();for(console.log(1);e.canGoLeft();)e.goLeft();console.log(2);const s=t.copy();let i=-1,h=null;for(let t=0;t<4;++t){let o=[],a=e.copy();for(let e=0;e<t;++e){a.rotate()&&o.push("rotate")}for(;a.canGoRiht();){for(;a.canGoDown();)o.push("down"),a.goDown(),console.log("d");o.push("right"),console.log("r"),a.goRight()}console.log("f"),s.setActualShape(a),s.displayShape();const r=s.getScore();s.removeLastShapeDraw(),r>i&&(i=r,h=o)}console.log(3);for(const t of h)switch(t){case"rotate":e.rotate();break;case"down":e.goDown();break;case"right":e.goRight()}console.log(4),t.haveLoose()?(this.stop(),this.gameHandler.loose()):(this.gameHandler.drawGame(),window.requestAnimationFrame((()=>this.main())))}start(){this.gameHandler.stop(),this.main()}stop(){this.clock&&clearTimeout(this.clock)}setFps(t){this.fps=t}}(g),u=document.querySelector("#fps"),f=document.querySelector("#start-ai"),S=document.querySelector("#stop-ai");u.addEventListener("change",(()=>p.setFps(Number(u.value)))),f.addEventListener("click",(()=>p.start())),S.addEventListener("click",(()=>p.stop()))}));
//# sourceMappingURL=index.js.map
